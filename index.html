<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Focus Trainer: Final Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }

        #ds-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #111;
            box-sizing: border-box;
        }

        /* === ìƒë‹¨ í™”ë©´ (ê²Œì„) === */
        #top-screen {
            flex: 1;
            position: relative;
            background: #000;
            border-bottom: 2px solid #333;
            overflow: hidden;
            margin: 5px;
            border-radius: 8px;
            border: 1px solid #444;
            display: flex; 
            flex-direction: column;
        }

        canvas#game-canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }

        #hp-bar-container {
            position: absolute;
            top: 10px; left: 10px; right: 10px;
            height: 8px;
            background: #330000;
            border: 1px solid #666;
            border-radius: 4px;
            z-index: 10;
        }
        #hp-bar {
            width: 100%; height: 100%;
            background: linear-gradient(to right, #ff3333, #00ff00);
            transition: width 0.1s linear;
        }

        /* === í•˜ë‹¨ í™”ë©´ (í€´ì¦ˆ) === */
        #bottom-screen {
            flex: 1;
            position: relative;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 5px;
            border-radius: 8px;
            border: 1px solid #444;
            transition: flex 0.3s;
        }

        /* í€´ì¦ˆ ì˜ì—­ */
        #quiz-area {
            width: 100%;
            height: 100%;
            background: #222;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            pointer-events: auto; 
            z-index: 20;
        }

        /* ì—°ìŠµëª¨ë“œ ë‚˜ê°€ê¸° ë²„íŠ¼ */
        #btn-practice-exit {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            z-index: 50;
            display: none; /* ì—°ìŠµëª¨ë“œì—ì„œë§Œ í‘œì‹œ */
        }

        .q-type { color: #aaa; font-size: 14px; margin-bottom: 10px; font-weight: bold; }
        .q-text { color: white; font-size: 22px; font-weight: bold; line-height: 1.4; word-break: keep-all; flex: 1; display: flex; align-items: center; justify-content: center; }
        .q-answer { color: #00ff00; font-size: 18px; margin-top: 5px; font-weight: bold; display: none; }
        .q-timer { color: #00ffff; font-size: 24px; margin-top: 10px; font-family: monospace; display: none;}
        
        #mic-status { font-size: 12px; color: #666; margin-top: 10px; width: 100%; }
        .listening { color: #ff5555 !important; animation: pulse 1s infinite; }

        /* ì˜¤ë²„ë ˆì´ */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow-y: auto;
        }
        #game-over, #game-clear, #start-screen, #main-menu { z-index: 200; }

        .btn-start {
            padding: 15px 40px;
            font-size: 20px;
            background: #00ff00;
            color: black;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            width: 80%;
            max-width: 300px;
        }
        .btn-mode {
            background: #00ffff; 
            color: black; 
            height: 90px; 
            font-size: 24px;
            line-height: 1.2;
        }
        .mode-desc {
            font-size: 14px; 
            font-weight: normal; 
            color: #444;
            display: block;
            margin-top: 5px;
        }
        .btn-retry { background: #ff3333; color: white; }
        .btn-sub { background: #444; color: white; font-size: 16px; }

        /* ì„¤ì • UI */
        .settings-box {
            width: 90%;
            max-width: 500px;
            background: #222;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .section-title { color: #00ffff; font-size: 16px; margin: 15px 0 5px 0; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .radio-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .radio-horizontal { flex-direction: row; justify-content: space-between; }
        
        .checkbox-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        label { display: flex; align-items: center; gap: 5px; cursor: pointer; color: #ddd; font-size: 14px; }
        
        .desc-text { font-size: 12px; color: #888; margin-left: 25px; margin-bottom: 5px; display: block;}

        /* ë¬¸ì œ ì„ íƒê¸° */
        #problem-selector {
            display: none;
            width: 100%;
        }
        .tab-container { display: flex; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #333; color: #888; }
        .tab.active { background: #555; color: white; font-weight: bold; }
        
        .problem-list {
            max-height: 200px;
            overflow-y: auto;
            background: #111;
            padding: 5px;
            border: 1px solid #444;
        }
        .problem-item {
            display: flex;
            align-items: flex-start;
            padding: 8px;
            border-bottom: 1px solid #333;
            font-size: 13px;
            text-align: left;
        }
        .problem-item input { margin-right: 10px; margin-top: 3px; flex-shrink: 0; width: 18px; height: 18px; }

        .mode-specific { display: none; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

<div id="ds-container">
    <div id="top-screen">
        <canvas id="game-canvas"></canvas>
        <div id="hp-bar-container"><div id="hp-bar"></div></div>
        
        <div id="game-over" class="overlay" style="display:none;">
            <h1 style="color:red">í›ˆë ¨ ì‹¤íŒ¨</h1>
            <p>ì˜ì—­ ì´íƒˆ</p>
            <button class="btn-start btn-retry" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
        </div>
        
        <div id="game-clear" class="overlay" style="display:none;">
            <h1 style="color:#00ff00">ì™„ë£Œ</h1>
            <p>ëª¨ë“  ë¬¸ì œ í•´ê²°</p>
            <div style="display:flex; flex-direction:column; width:100%; align-items:center;">
                <button class="btn-start" onclick="app.restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
                <button class="btn-start btn-sub" onclick="location.reload()">í™ˆìœ¼ë¡œ</button>
            </div>
        </div>
    </div>

    <div id="bottom-screen">
        <div id="quiz-area">
            <button id="btn-practice-exit" onclick="location.reload()">ë‚˜ê°€ê¸°</button>
            
            <div class="q-type" id="q-type">READY</div>
            <div class="q-text" id="q-text">ëª¨ë“œ ì„ íƒ ì¤‘...</div>
            <div class="q-timer" id="q-timer">00.00</div>
            <div class="q-answer" id="q-answer">ì •ë‹µ</div>
            <div id="mic-status"></div>
        </div>
    </div>

    <div id="main-menu" class="overlay">
        <h1 style="color:#00ff00; margin-bottom: 30px;">Focus Trainer</h1>
        <button class="btn-start btn-mode" onclick="app.selectMode('game')">
            ğŸ® ê²Œì„ ëª¨ë“œ
            <span class="mode-desc">ì¶”ì  ê²Œì„ + êµ¬ìˆ  í›ˆë ¨</span>
        </button>
        <button class="btn-start btn-mode" style="background:#ffcc00;" onclick="app.selectMode('practice')">
            ğŸ“š ì—°ìŠµ ëª¨ë“œ
            <span class="mode-desc">ë¬¸ì œ í’€ì´ ì§‘ì¤‘ (ê²Œì„ X)</span>
        </button>
    </div>

    <div id="start-screen" class="overlay" style="display:none;">
        <h2 style="color:#00ff00; margin: 20px 0;" id="setting-title">ì„¤ì •</h2>
        
        <div class="settings-box">
            
            <div class="section-title">ë¬¸ì œ ì¶œì œ ë°©ì‹</div>
            <div class="radio-group radio-horizontal">
                <label><input type="radio" name="q-mode" value="all" checked onchange="ui.toggleProblemSelector(false)"> ì „ì²´ ëœë¤</label>
                <label><input type="radio" name="q-mode" value="select" onchange="ui.toggleProblemSelector(true)"> ë¬¸ì œ ì„ íƒ</label>
            </div>
            
            <div id="problem-selector">
                <div class="tab-container">
                    <div id="tab-prev" class="tab active" onclick="ui.switchTab('prev')">ê¸°ì¡´ ê¸°ì¶œ</div>
                    <div id="tab-oral" class="tab" onclick="ui.switchTab('oral')">ì¶”ê°€ êµ¬ìˆ </div>
                </div>
                <div id="list-prev" class="problem-list"></div>
                <div id="list-oral" class="problem-list" style="display:none;"></div>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn-sub" style="padding:5px 10px; width:auto;" onclick="ui.selectAll(true)">ì „ì²´ ì„ íƒ</button>
                    <button class="btn-sub" style="padding:5px 10px; width:auto;" onclick="ui.selectAll(false)">ì „ì²´ í•´ì œ</button>
                </div>
            </div>

            <div id="settings-game" class="mode-specific">
                <div class="section-title">ë‚œì´ë„ (ê³µ ì¶”ì  ì†ë„)</div>
                <div class="radio-group radio-horizontal">
                    <label><input type="radio" name="diff" value="easy"> ì‰¬ì›€</label>
                    <label><input type="radio" name="diff" value="normal" checked> ë³´í†µ</label>
                    <label><input type="radio" name="diff" value="hard"> ì–´ë ¤ì›€</label>
                </div>
                <p class="desc-text">* ë³´í†µ: ì ë‹¹í•œ ê¸´ì¥ê°ìœ¼ë¡œ ë”°ë¼ê°ˆ ìˆ˜ ìˆëŠ” ì†ë„</p>
            </div>

            <div id="settings-practice" class="mode-specific">
                <div class="section-title">ì—°ìŠµ ë°©ì‹ ì„¤ì •</div>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="p-mode" value="continuous" checked onchange="ui.toggleTimerSetting(false)"> 
                        ì—°ì† ëª¨ë“œ
                    </label>
                    <span class="desc-text">ë‹µë³€ ì™„ë£Œ ì‹œ ì¦‰ì‹œ ë‹¤ìŒ ë¬¸ì œ</span>
                    
                    <label>
                        <input type="radio" name="p-mode" value="timer" onchange="ui.toggleTimerSetting(true)"> 
                        ì‹œê°„ ì„¤ì • ëª¨ë“œ
                    </label>
                    <span class="desc-text">ì •í•´ì§„ ì‹œê°„ë§ˆë‹¤ ë¬¸ì œ ìë™ ë³€ê²½</span>
                </div>

                <div id="timer-input-area" style="display:none; margin-top:10px; border-top:1px dashed #444; padding-top:10px;">
                    <label style="font-size:16px;">
                        â±ï¸ ê°„ê²© ì„¤ì •: 
                        <input type="number" id="p-interval" value="1" style="width:60px; background:#333; color:white; border:1px solid #555; padding:5px; margin:0 10px;"> 
                        ë¶„
                    </label>
                </div>
            </div>

            <div class="section-title">ìŒì„± / TTS ì„¤ì •</div>
            <div class="checkbox-row">
                <label><input type="checkbox" id="use-voice" checked> ë‚´ ëª©ì†Œë¦¬ ì¸ì‹ (Chrome)</label>
            </div>
            <div class="checkbox-row">
                <label><input type="checkbox" id="use-tts" checked> ë¬¸ì œ ì½ì–´ì£¼ê¸° (TTS)</label>
            </div>
        </div>

        <button class="btn-start" onclick="app.start()">ì‹œì‘í•˜ê¸°</button>
        <button class="btn-start btn-sub" onclick="location.reload()">ë’¤ë¡œ ê°€ê¸°</button>
    </div>
</div>

<script>
/* ------------------------------------------------------------------
   1. ë°ì´í„°
------------------------------------------------------------------ */
const QUESTIONS_ORAL = [
    "1. ARL ì„¤ì¹˜ì°¨ëŸ‰ì˜ ì ‘ì§€ ë³µê·€ ë°©ë²•",
    "2. 7400í˜¸ëŒ€ ë””ì ¤ì „ê¸°ê¸°ê´€ì°¨ì— ì„¤ì¹˜ëœ ì „ë™ê¸°ì˜ ì¢…ë¥˜",
    "3. ì§€ì í™•ì¸ í™˜í˜¸ì‘ë‹µ í™˜í˜¸ìš©ì–´(ê¸°ì™¸ì •ì°¨ ê²½ê³ ë“± ê²½ê³  ì‹œ ë“±)",
    "4. ATP ìš´ì „ëª¨ë“œì˜ ì¢…ë¥˜",
    "5. ATP ìš´í–‰ ì‹œ íŠ¹ìˆ˜ìš´ì „ê¸°ëŠ¥ í™œì„±í™” ì‹œ ì´ë™ê±°ë¦¬ ì œí•œê³¼ í™œì„±í™” ì‹œê°„ ì œí•œ?",
    "7. ì§€ë„í‘œì™€ ì§€ë„ê¶Œì— ëŒ€í•œ ì„¤ëª…",
    "8. ì§€ë ¹ì‹ì˜ ì •ì˜ì™€ í†µë³´ ë°›ê³  ê¸°ê´€ì‚¬ì˜ ì¡°ì¹˜(ìš´ì „ì·¨ê¸‰ê·œì • ì œ138ì¡°)",
    "9. ë¹„ì¥ì°©ëª¨ë“œë¡œ ìš´í–‰í•˜ì—¬ì•¼ í•˜ëŠ” ê²½ìš°",
    "10. ì €ìœ ì•• ê¸°ê´€ì •ì§€ì¥ì¹˜ê°€ ë™ì‘í•˜ëŠ” ê²½ìš°",
    "11. ë””ì ¤ì „ê¸°ê¸°ê´€ì°¨ ì €ì••ê³„í†µì˜ ì¢…ë¥˜",
    "13. ê¸°ê´€ì „ë¶€ì— ìˆëŠ” ì¹˜ì°¨ì˜ ì¢…ë¥˜ì™€ ë¶€ì†ì¥ì¹˜ êµ¬ë™ì¹˜ì°¨ì™€ ë°˜ëŒ€ë°©í–¥ìœ¼ë¡œ íšŒì „í•˜ëŠ” ì¹˜ì°¨ì˜ ì¢…ë¥˜"
];

const QUESTIONS_PREV = [
    "1. ê³µê¸°ì œë™ì‹œí—˜ì„ ì‹œí–‰í•˜ëŠ” ê²½ìš°ëŠ” ì–¸ì œì¸ê°€?",
    "2. ì œë™ê°ë„ì‹œí—˜ì„ ìƒëµí•  ìˆ˜ ìˆëŠ” ê²½ìš°ëŠ” ì–¸ì œì¸ê°€?",
    "3. ì—´ì°¨ ìš´í–‰ ì¤‘ ì œë™ê¸° ì‚¬ìš©ë¶ˆëŠ¥ì°¨ ë°œìƒì‹œ ì¡°ì¹˜ëŠ”?",
    "4. 1íìƒ‰êµ¬ê°„ì— 2ê°œ ì—´ì°¨ë¥¼ ìš´ì „í•  ìˆ˜ ìˆëŠ” ê²½ìš°ëŠ” ì–¸ì œì¸ê°€",
    "5. ë³µì„  ìë™íìƒ‰êµ¬ê°„ì—ì„œ í†µì‹ ì‹ ì‹œí–‰ ê²½ìš° (5ê°€ì§€)",
    "5-1. í†µì‹ ì‹ ì‹œí–‰ì‹œì˜ ìš´ì „ë²•",
    "6. ìë™íìƒ‰ì‹ê³¼ ì§€ë„í†µì‹ ì‹ ë³‘ìš©ì‹œì˜ ìš´ì „ì·¨ê¸‰ë²•",
    "8. êµ¬ì›ì—´ì°¨ ìš”êµ¬ì‹œì˜ ì·¨ê¸‰ë²•(êµ¬ì›ì„ ìš”êµ¬í•œ ê³ ì¥ì—´ì°¨)",
    "9. êµ¬ì›ì—´ì°¨ ìš´ì „ë²•(êµ¬ì›í•˜ëŸ¬ ê°€ëŠ” ì—´ì°¨)",
    "10. ì „ë ¹ë²• ì‹œí–‰ ì‹œ ìš´ì „ì·¨ê¸‰ë²•ì€?",
    "11. ì›ë°©ì‹ í˜¸ ì£¼ì˜ì‹ í˜¸ í˜„ì‹œ ì‹œ ì£¼ì˜ì‹ í˜¸ ì†ë„ ì´ìƒìœ¼ë¡œ ìš´ì „ê°€ëŠ¥í•œ ê²½ìš°ëŠ” ì–¸ì œì¸ê°€",
    "12. ê¸°ì  ê³ ì¥ì‹œì˜ ìš´ì „ë²•",
    "13. ì •ê±°ì¥ì—ì„œ ì—´ì°¨ë¥¼ ë™ì‹œì— ì§„ì… ë° ì§„ì¶œ ê°€ëŠ¥í•œ ê²½ìš°ëŠ” ì–¸ì œì¸ê°€",
    "14. ì¹¨ìˆ˜ëœ ì„ ë¡œë¥¼ ìš´ì „ ì‹œ ì—´ì°¨ ìš´ì „ë²•ì€?",
    "15. ì´ê´„ì œì–´ì‹œ í”¼ì œì–´ì°¨ì˜ ê¸°ê¸°ì·¨ê¸‰ë²•ê³¼ ìš´ì „ë³´ì•ˆì¥ì¹˜ ì·¨ê¸‰ë²•",
    "16. ì´ê´„ì œì–´ì‹œ í”¼ì œì–´ì°¨ë¥¼ ì œì–´ì°¨ë¡œ ë§Œë“œëŠ” ë°©ë²•",
    "17-18. 26-Fì œì–´ë³€ì˜ ê¸°ëŠ¥ê³¼ ê³ ì¥ì‹œì˜ í˜„ìƒ",
    "19-20. J-1ì¤‘ê³„ë³€ì˜ ê¸°ëŠ¥ê³¼ ê³ ì¥ì‹œì˜ í˜„ìƒ",
    "21. ìë³€ ì·¨ê¸‰ë²•(ìë³€ìœ¼ë¡œ ì œë™ ì²´ê²°ì‹œ ì²´ê²°ê³¼ì •)",
    "22. ë‹¨ë³€ ì·¨ê¸‰ë²•(ë‹¨ë³€ìœ¼ë¡œ ì œë™ ì²´ê²°ì‹œ ì²´ê²°ê³¼ì •)",
    "23. A-1ì¶©ê¸°ì°¨ë‹¨ì•ˆë‚´ë³€ ë™ì‘ì›ì¸ê³¼ í˜„ìƒ, ì¡°ì¹˜ë°©ë²•",
    "24. ì£¼ê³µê¸°ì••ë ¥ì´ 9í‚¤ë¡œê¹Œì§€ ìƒìŠ¹ë¶ˆëŠ¥ì‹œ ì›ì¸ 5ê°€ì§€",
    "25. ê³µê¸°ì••ì¶•ê¸° ê³„ì† ë¬´ë¶€í•˜ ìš´ì „ì‹œì˜ ì¡°ì¹˜ ìˆœì„œ",
    "26. ê¸°ê´€ì œì–´íŒ¨ë„ì˜ ë¬´ì¶©ì „/ë¬´ì „ì›ë“±(NVRë“±) ì ë“± ì‹œ í™•ì¸í•´ì•¼ ë  ê²ƒ 5ê°€ì§€",
    "27. ì—¬ìì œí•œ ê²½ë³´ì˜ í˜„ìƒê³¼ ì¡°ì¹˜ë°©ë²•",
    "28. ê¸°ê´€íšŒì „ì†ë„ëŠ” ì •ìƒì´ë‚˜ ì£¼ë°œì „ê¸° ì¶œë ¥ì´ ë‚˜ì§€ ì•ŠëŠ” ê²½ìš°",
    "29. ì¡°ì†ê¸°ì¤‘ì§€ë“± ì ë“± ì‹œì˜ í˜„ìƒ 3ê°€ì§€ì— ëŒ€í•´ ë§í•´ë³´ì‹­ì‹œì˜¤",
    "30. ê¸°ê´€ì œì–´íŒ¨ë„ì˜ ì¡°ì†ê¸°ì¤‘ì§€ë“± ì ë“± ì›ì¸ 3ê°€ì§€ì— ëŒ€í•´ ë§í•´ë³´ì‹­ì‹œì˜¤",
    "31. ê¸°ê´€ì˜¨ë„ìŠ¤ìœ„ì¹˜ ê¸°ëŠ¥ì‹œí—˜ ë°©ë²•ê³¼ ë™ì‘ì˜¨ë„",
    "32. TR16 ì „ì´ì œì–´ëª¨ë“ˆ ê¸°ëŠ¥ê²€ì‚¬ë²•ê³¼ ë°œì „ì œë™ì˜ ì›ë¦¬",
    "33. ê²½ë³´ê¸°ëª¨ë“ˆ AN29 ì ë“± ì‹œê¸° 6ê°€ì§€, ì ê²€ë°©ë²•",
    "34. ATS, ATC, ATP, ì—´ì°¨ë°©í˜¸ì¥ì¹˜ëŠ” ë¬´ì—‡ì¸ê°€",
    "35. ì—´ì°¨ë°©í˜¸ì¥ì¹˜ ë™ì‘ì‹œ ìš´ì „ì·¨ê¸‰ë²•",
    "35-1. ì—´ì°¨ë°©í˜¸ì¥ì¹˜ ì°¨ë‹¨ ë°©ë²•",
    "36. ì‹ í˜¸ë³´ì•ˆì¥ì¹˜ ì¥ì• ë°œìƒì‹œ(ê³ ì¥ì‹œ) ê¸°ê´€ì°¨ ì¡°ì¹˜ 3ê°œ",
    "37. ì—´ì°¨ì œì–´ì¥ì¹˜ ì°¨ë‹¨ìš´ì „ ìŠ¹ì¸ë²ˆí˜¸ë¥¼ ë¶€ì—¬ë°›ì•„ ì—´ì°¨ë¥¼ ìš´í–‰ì‹œí‚¬ ìˆ˜ ìˆëŠ” ê²½ìš°",
    "38. ATP ë ˆë²¨STMì˜ ëª¨ë“œì—ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆëŠ”ê°€",
    "39. ATP ë ˆë²¨ STMì˜ ì…í™˜ëª¨ë“œëŠ” ì–¸ì œ ì‚¬ìš©í•˜ëŠ”ê°€",
    "40. ATP ë ˆë²¨ STMì˜ ê³µì‚¬ëª¨ë“œëŠ” ì–¸ì œ ì‚¬ìš©í•˜ëŠ”ê°€",
    "41. ATP ë ˆë²¨ STMì˜ íŠ¹ìˆ˜ëª¨ë“œëŠ” ì–¸ì œ ì‚¬ìš©í•˜ëŠ”ê°€",
    "42. ATP ë¹„ì¥ì°©ëª¨ë“œ(ë ˆë²¨ 0)ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°"
];

/* ------------------------------------------------------------------
   2. ì¶”ì  ê²Œì„ (Tracker)
------------------------------------------------------------------ */
class TrackerGame {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        
        this.player = { x: 0, y: 0, radius: 15 };
        this.zone = { x: 0, y: 0, width: 100, height: 100, radius: 0, targetX: 0, targetY: 0 };
        
        this.difficulty = 'normal'; 
        this.zoneSpeed = 0; 
        this.health = 100;
        this.active = false;
        this.moveTimer = 0; 

        this.isDragging = false;
        this.dragOffset = { x: 0, y: 0 };
        
        this.resize();
        window.addEventListener('resize', () => this.resize());
        
        this.canvas.addEventListener('mousedown', e => this.handleStart(e));
        window.addEventListener('mousemove', e => this.handleMove(e));
        window.addEventListener('mouseup', e => this.handleEnd(e));
        
        this.canvas.addEventListener('touchstart', e => this.handleStart(e), {passive: false});
        window.addEventListener('touchmove', e => this.handleMove(e), {passive: false});
        window.addEventListener('touchend', e => this.handleEnd(e));
    }

    getPos(e) {
        let cx, cy;
        if(e.touches) {
            cx = e.touches[0].clientX;
            cy = e.touches[0].clientY;
        } else {
            cx = e.clientX;
            cy = e.clientY;
        }
        const rect = this.canvas.getBoundingClientRect();
        return { x: cx - rect.left, y: cy - rect.top };
    }

    handleStart(e) {
        if (!this.active) return;
        e.preventDefault();
        const pos = this.getPos(e);
        const dist = Math.sqrt((pos.x - this.player.x)**2 + (pos.y - this.player.y)**2);
        
        if (dist < this.player.radius * 2.5) {
            this.isDragging = true;
            this.dragOffset.x = pos.x - this.player.x;
            this.dragOffset.y = pos.y - this.player.y;
        }
    }

    handleMove(e) {
        if (!this.active || !this.isDragging) return;
        e.preventDefault(); 
        const pos = this.getPos(e);
        
        this.player.x = pos.x - this.dragOffset.x;
        this.player.y = pos.y - this.dragOffset.y;

        this.player.x = Math.max(this.player.radius, Math.min(this.canvas.width - this.player.radius, this.player.x));
        this.player.y = Math.max(this.player.radius, Math.min(this.canvas.height - this.player.radius, this.player.y));
    }

    handleEnd(e) {
        this.isDragging = false;
    }

    resize() {
        this.canvas.width = this.canvas.parentElement.clientWidth;
        this.canvas.height = this.canvas.parentElement.clientHeight;
        if (!this.active && this.canvas.width > 0) {
            this.player.x = this.canvas.width / 2;
            this.player.y = this.canvas.height / 2;
            this.zone.x = this.canvas.width / 2;
            this.zone.y = this.canvas.height / 2;
        }
    }

    start(diff) {
        this.difficulty = diff;
        this.active = true;
        this.health = 100;
        this.isDragging = false;
        
        this.resize(); 

        if (diff === 'easy') {
            this.zoneSpeed = 2.5; 
            this.zone.width = 160; this.zone.height = 160;
            this.zone.radius = 0;
        } else if (diff === 'normal') {
            this.zoneSpeed = 4.5; 
            this.zone.width = 130; this.zone.height = 130;
            this.zone.radius = 15; 
        } else {
            this.zoneSpeed = 7.0; 
            this.zone.width = 100; this.zone.height = 100;
            this.zone.radius = 15;
        }
    }

    update() {
        if (!this.active) return;
        this.updateZoneAI();
        this.checkCollision();
    }

    updateZoneAI() {
        const pad = 100;
        const dx = this.zone.targetX - this.zone.x;
        const dy = this.zone.targetY - this.zone.y;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if (dist < 10 || this.moveTimer <= 0) {
            this.zone.targetX = pad + Math.random() * (this.canvas.width - pad*2);
            this.zone.targetY = pad + Math.random() * (this.canvas.height - pad*2);
            this.moveTimer = 80 + Math.random() * 80; 
        }
        this.moveTimer--;

        const angle = Math.atan2(dy, dx);
        this.zone.x += Math.cos(angle) * this.zoneSpeed;
        this.zone.y += Math.sin(angle) * this.zoneSpeed;
        
        if (this.difficulty === 'hard') {
            const time = Date.now() / 500;
            this.zone.radius = 10 + ((Math.sin(time) + 1) * 20);
        }

        this.zone.x = Math.max(pad, Math.min(this.canvas.width - pad, this.zone.x));
        this.zone.y = Math.max(pad, Math.min(this.canvas.height - pad, this.zone.y));
    }

    checkCollision() {
        const halfW = this.zone.width / 2;
        const halfH = this.zone.height / 2;
        const dx = Math.abs(this.player.x - this.zone.x);
        const dy = Math.abs(this.player.y - this.zone.y);
        let inside = false;

        if (dx < halfW && dy < halfH) inside = true;

        const hpBar = document.getElementById('hp-bar');
        if (inside) {
            this.ctx.strokeStyle = "#00ff00"; 
            this.health = Math.min(100, this.health + 0.15); 
        } else {
            this.ctx.strokeStyle = "#ff0000"; 
            this.health -= 0.15; // ì²´ë ¥ ê°ì†Œ ì†ë„ ì¦ê°€ (0.1 -> 0.15)
            if (this.health <= 0) {
                this.health = 0;
                app.gameOver();
            }
        }
        hpBar.style.width = this.health + "%";
    }

    render() {
        this.ctx.fillStyle = "#000";
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        this.ctx.strokeStyle = "#222";
        this.ctx.lineWidth = 1;
        const gridSize = 50;
        this.ctx.beginPath();
        for(let x=0; x<this.canvas.width; x+=gridSize) {
            this.ctx.moveTo(x, 0); this.ctx.lineTo(x, this.canvas.height);
        }
        for(let y=0; y<this.canvas.height; y+=gridSize) {
            this.ctx.moveTo(0, y); this.ctx.lineTo(this.canvas.width, y);
        }
        this.ctx.stroke();

        this.ctx.lineWidth = 4;
        this.ctx.strokeStyle = this.ctx.strokeStyle === "#00ff00" ? "#00ff00" : "#ff0000";
        this.drawRoundRect(this.zone.x - this.zone.width/2, this.zone.y - this.zone.height/2, 
                           this.zone.width, this.zone.height, this.zone.radius);
        this.ctx.stroke();
        this.ctx.fillStyle = this.ctx.strokeStyle === "#00ff00" ? "rgba(0, 255, 0, 0.1)" : "rgba(255, 0, 0, 0.1)";
        this.ctx.fill();

        this.ctx.fillStyle = "#00ffff";
        this.ctx.shadowBlur = 15;
        this.ctx.shadowColor = "#00ffff";
        this.ctx.beginPath();
        this.ctx.arc(this.player.x, this.player.y, this.player.radius, 0, Math.PI*2);
        this.ctx.fill();
        this.ctx.shadowBlur = 0;
    }

    drawRoundRect(x, y, w, h, r) {
        this.ctx.beginPath();
        this.ctx.moveTo(x + r, y);
        this.ctx.arcTo(x + w, y, x + w, y + h, r);
        this.ctx.arcTo(x + w, y + h, x, y + h, r);
        this.ctx.arcTo(x, y + h, x, y, r);
        this.ctx.arcTo(x, y, x + w, y, r);
        this.ctx.closePath();
    }
}

/* ------------------------------------------------------------------
   3. í€´ì¦ˆ ë§¤ë‹ˆì €
------------------------------------------------------------------ */
class QuizManager {
    constructor() {
        this.currentSet = [];
        this.remaining = [];
        this.active = false;
        this.state = 'idle'; 
        this.timerStart = 0;
        this.timerRef = null;
        this.nextTimer = null;
        this.intervalTimer = null;
        
        this.mode = 'game'; 
        this.practiceType = 'continuous'; 
        this.practiceInterval = 60; 

        this.useVoice = false;
        this.useTTS = false;
        this.recognition = null;
        this.initVoice();
    }

    initVoice() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SR) {
            this.recognition = new SR();
            this.recognition.lang = 'ko-KR';
            this.recognition.continuous = true;
            this.recognition.interimResults = false;
            this.recognition.onresult = (e) => {
                const txt = e.results[e.results.length-1][0].transcript.replace(/\s/g, '');
                this.processVoice(txt);
            };
            this.recognition.onend = () => {
                if (this.active && this.useVoice) try{this.recognition.start()}catch(e){}
            };
        }
    }

    processVoice(txt) {
        if (!this.active) return;
        
        if (this.mode === 'game' || (this.mode === 'practice' && this.practiceType === 'continuous')) {
            if (this.state === 'question') {
                if (txt.startsWith('ì˜ˆ') || txt.startsWith('ë„¤') || txt.includes('ì‹œì‘')) {
                    this.startAnswering();
                }
            } else if (this.state === 'answering') {
                if (txt.includes('ì´ìƒ') || txt.includes('ë')) {
                    this.finishAnswering();
                }
            }
        }
    }

    setQuestions(list) {
        this.currentSet = [...list];
    }

    start(config) {
        this.active = true;
        this.mode = config.mode;
        this.practiceType = config.practiceType;
        this.practiceInterval = config.practiceInterval;
        this.useVoice = config.useVoice;
        this.useTTS = config.useTTS;

        this.remaining = [...this.currentSet].sort(() => Math.random() - 0.5);
        if (this.useVoice && this.recognition) try{this.recognition.start()}catch(e){}
        
        // ë²„íŠ¼ í‘œì‹œ ì œì–´
        document.getElementById('btn-practice-exit').style.display = (this.mode === 'practice') ? 'block' : 'none';

        if (this.mode === 'practice' && this.practiceType === 'timer') {
             this.showQuestion();
             this.intervalTimer = setInterval(() => {
                 this.finishAnswering(true); 
             }, this.practiceInterval * 1000);
        } else {
            this.scheduleNext();
        }
    }

    stop() {
        this.active = false;
        if (this.recognition) try{this.recognition.stop()}catch(e){}
        clearTimeout(this.nextTimer);
        clearInterval(this.intervalTimer);
        cancelAnimationFrame(this.timerRef);
        window.speechSynthesis.cancel(); 
    }

    scheduleNext() {
        if (this.remaining.length === 0) {
            if (this.mode === 'practice') {
                 this.remaining = [...this.currentSet].sort(() => Math.random() - 0.5);
            } else {
                 app.gameClear();
                 return;
            }
        }

        const delay = this.mode === 'game' ? (3000 + Math.random() * 3000) : 500;
        
        this.state = 'idle';
        document.getElementById('q-type').innerText = "STANDBY";
        document.getElementById('q-text').innerText = `ëŒ€ê¸° ì¤‘... (ë‚¨ì€: ${this.remaining.length})`;
        document.getElementById('q-answer').style.display = 'none';
        document.getElementById('q-timer').style.display = 'none';
        
        const micEl = document.getElementById('mic-status');
        micEl.innerText = "ë‹¤ìŒ ë¬¸ì œ ì¤€ë¹„ ì¤‘...";
        micEl.className = "";

        this.nextTimer = setTimeout(() => this.showQuestion(), delay);
    }

    showQuestion() {
        if (!this.active) return;
        
        if (this.remaining.length === 0) {
            if (this.mode === 'practice') {
                 this.remaining = [...this.currentSet].sort(() => Math.random() - 0.5);
            } else {
                 app.gameClear();
                 return;
            }
        }

        const rawQ = this.remaining.pop();
        const displayText = rawQ.replace(/^[0-9]+(-[0-9]+)?\.\s*/, "");

        this.state = 'question';
        document.getElementById('q-type').innerText = "QUESTION";
        document.getElementById('q-text').innerText = displayText;
        
        if (this.useTTS) this.speak(displayText);

        const micEl = document.getElementById('mic-status');
        
        if (this.mode === 'practice' && this.practiceType === 'timer') {
             micEl.innerText = `â³ ${this.practiceInterval / 60}ë¶„ ë§ˆë‹¤ ë³€ê²½ ì¤‘`;
             this.state = 'viewing'; 
        } else {
            if (this.useVoice) {
                micEl.innerText = "ğŸ¤ 'ì˜ˆ'ë¼ê³  ë‹µí•˜ë©´ íƒ€ì´ë¨¸ ì‹œì‘";
                micEl.className = "listening";
            } else {
                micEl.innerText = "í„°ì¹˜í•˜ì—¬ ë‹µë³€ ì‹œì‘";
                micEl.className = "";
            }
        }
    }
    
    speak(text) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 1.0; 
        window.speechSynthesis.speak(utterance);
    }

    startAnswering() {
        if (this.mode === 'practice' && this.practiceType === 'timer') return;

        window.speechSynthesis.cancel(); 
        this.state = 'answering';
        this.timerStart = performance.now();
        document.getElementById('q-type').innerText = "RECORDING...";
        document.getElementById('q-timer').style.display = 'block';
        
        const micEl = document.getElementById('mic-status');
        if (this.useVoice) micEl.innerText = "ğŸ—£ï¸ ë‹µë³€ í›„ 'ì´ìƒì…ë‹ˆë‹¤' ë°œì–¸";
        else micEl.innerText = "ë‹µë³€ í›„ í„°ì¹˜í•˜ì—¬ ì™„ë£Œ";
        
        this.updateTimer();
    }

    updateTimer() {
        if (this.state !== 'answering') return;
        const now = performance.now();
        const t = (now - this.timerStart) / 1000;
        document.getElementById('q-timer').innerText = t.toFixed(2);
        this.timerRef = requestAnimationFrame(() => this.updateTimer());
    }

    finishAnswering(auto = false) {
        this.state = 'result';
        cancelAnimationFrame(this.timerRef);
        document.getElementById('q-type').innerText = "DONE";
        document.getElementById('mic-status').className = "";

        if (auto) {
            this.showQuestion();
        } else {
            document.getElementById('mic-status').innerText = "ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.";
            const waitTime = (this.mode === 'practice') ? 500 : 3000;
            setTimeout(() => {
                if(this.active) this.scheduleNext();
            }, waitTime);
        }
    }

    handleTouch() {
        if (this.mode === 'practice' && this.practiceType === 'timer') return;
        if (this.state === 'question') this.startAnswering();
        else if (this.state === 'answering') this.finishAnswering();
    }
}

/* ------------------------------------------------------------------
   4. UI ë° ì•± ì»¨íŠ¸ë¡¤ëŸ¬
------------------------------------------------------------------ */
const ui = {
    toggleProblemSelector: function(show) {
        document.getElementById('problem-selector').style.display = show ? 'block' : 'none';
        if (show) this.checkAndLoadHistory();
    },
    toggleTimerSetting: function(show) {
        document.getElementById('timer-input-area').style.display = show ? 'block' : 'none';
    },
    switchTab: function(tab) {
        const tabPrev = document.getElementById('tab-prev');
        const tabOral = document.getElementById('tab-oral');
        const listPrev = document.getElementById('list-prev');
        const listOral = document.getElementById('list-oral');

        if (tab === 'prev') {
            tabPrev.classList.add('active');
            tabOral.classList.remove('active');
            listPrev.style.display = 'block';
            listOral.style.display = 'none';
        } else {
            tabPrev.classList.remove('active');
            tabOral.classList.add('active');
            listPrev.style.display = 'none';
            listOral.style.display = 'block';
        }
    },
    renderList: function(id, list) {
        const container = document.getElementById(id);
        container.innerHTML = list.map(q => `
            <label class="problem-item">
                <input type="checkbox" value="${q}">
                ${q}
            </label>
        `).join('');
    },
    selectAll: function(select) {
        const activeListId = document.getElementById('list-prev').style.display !== 'none' ? 'list-prev' : 'list-oral';
        const inputs = document.getElementById(activeListId).querySelectorAll('input');
        inputs.forEach(input => input.checked = select);
    },
    getSelectedQuestions: function() {
        const mode = document.querySelector('input[name="q-mode"]:checked').value;
        if (mode === 'all') {
            return [...QUESTIONS_PREV, ...QUESTIONS_ORAL];
        } else {
            const inputs = document.querySelectorAll('.problem-item input:checked');
            return Array.from(inputs).map(input => input.value);
        }
    },
    // ì €ì¥ëœ ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°
    checkAndLoadHistory: function() {
        const saved = localStorage.getItem('focusTrainer_lastSelection');
        if (!saved) return;
        
        if (this.historyLoaded) return;

        if (confirm("ì´ì „ì— ì„ íƒí–ˆë˜ ë¬¸ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const savedList = JSON.parse(saved);
            const inputs = document.querySelectorAll('.problem-item input');
            inputs.forEach(input => {
                if (savedList.includes(input.value)) input.checked = true;
            });
            this.historyLoaded = true;
        } else {
            this.historyLoaded = true; 
        }
    },
    saveHistory: function(list) {
        localStorage.setItem('focusTrainer_lastSelection', JSON.stringify(list));
    }
};

const tracker = new TrackerGame('game-canvas');
const quiz = new QuizManager();

const app = {
    mode: 'game', 

    init: function() {
        ui.renderList('list-prev', QUESTIONS_PREV);
        ui.renderList('list-oral', QUESTIONS_ORAL);
    },
    selectMode: function(mode) {
        this.mode = mode;
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('start-screen').style.display = 'flex';

        ui.historyLoaded = false;

        if (mode === 'game') {
            document.getElementById('setting-title').innerText = "ê²Œì„ ëª¨ë“œ ì„¤ì •";
            document.getElementById('settings-game').style.display = 'block';
            document.getElementById('settings-practice').style.display = 'none';
        } else {
            document.getElementById('setting-title').innerText = "ì—°ìŠµ ëª¨ë“œ ì„¤ì •";
            document.getElementById('settings-game').style.display = 'none';
            document.getElementById('settings-practice').style.display = 'block';
        }
    },
    start: function() {
        const selectedQ = ui.getSelectedQuestions();
        if (selectedQ.length === 0) {
            alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }
        
        if (document.querySelector('input[name="q-mode"]:checked').value === 'select') {
            ui.saveHistory(selectedQ);
        }

        const useVoice = document.getElementById('use-voice').checked;
        const useTTS = document.getElementById('use-tts').checked;
        
        let practiceType = 'continuous';
        let practiceInterval = 60;

        if (this.mode === 'practice') {
            practiceType = document.querySelector('input[name="p-mode"]:checked').value;
            // ë¶„ ë‹¨ìœ„ë¥¼ ì´ˆë¡œ ë³€í™˜
            practiceInterval = (parseInt(document.getElementById('p-interval').value) || 1) * 60;
        }

        document.getElementById('start-screen').style.display = 'none';
        
        const topScreen = document.getElementById('top-screen');
        const bottomScreen = document.getElementById('bottom-screen');

        if (this.mode === 'game') {
            topScreen.style.display = 'flex';
            topScreen.style.flex = '1';
            bottomScreen.style.flex = '1';
            const diff = document.querySelector('input[name="diff"]:checked').value;
            tracker.start(diff);
            this.loop();
        } else {
            topScreen.style.display = 'none';
            bottomScreen.style.height = '100%';
        }

        quiz.setQuestions(selectedQ);
        quiz.start({
            mode: this.mode,
            practiceType: practiceType,
            practiceInterval: practiceInterval,
            useVoice: useVoice,
            useTTS: useTTS
        });
    },
    loop: function() {
        if (!tracker.active) return;
        tracker.update();
        tracker.render();
        requestAnimationFrame(() => this.loop());
    },
    gameOver: function() {
        tracker.active = false;
        quiz.stop();
        document.getElementById('game-over').style.display = 'flex';
    },
    gameClear: function() {
        tracker.active = false;
        quiz.stop();
        document.getElementById('game-clear').style.display = 'flex';
    },
    restartGame: function() {
        document.getElementById('game-clear').style.display = 'none';
        
        if (this.mode === 'game') {
            tracker.start(tracker.difficulty);
            this.loop();
        }
        
        quiz.start({
            mode: this.mode,
            practiceType: quiz.practiceType,
            practiceInterval: quiz.practiceInterval,
            useVoice: quiz.useVoice,
            useTTS: quiz.useTTS
        });
    }
};

app.init();

const quizArea = document.getElementById('quiz-area');
quizArea.addEventListener('mousedown', (e) => {
    if(e.target.id === 'btn-practice-exit') return;
    quiz.handleTouch();
});
quizArea.addEventListener('touchstart', (e) => {
    if(e.target.id === 'btn-practice-exit') return;
    e.preventDefault();
    quiz.handleTouch();
});

</script>
</body>
</html>
