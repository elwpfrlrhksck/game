<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Focus Trainer: Final Complete</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }

        #ds-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #111;
            box-sizing: border-box;
        }

        /* === ìƒë‹¨ í™”ë©´ (ê²Œì„) === */
        #top-screen {
            flex: 1;
            position: relative;
            background: #000;
            border-bottom: 2px solid #333;
            overflow: hidden;
            margin: 5px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        canvas#game-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #hp-bar-container {
            position: absolute;
            top: 10px; left: 10px; right: 10px;
            height: 8px;
            background: #330000;
            border: 1px solid #666;
            border-radius: 4px;
            z-index: 10;
        }
        #hp-bar {
            width: 100%; height: 100%;
            background: linear-gradient(to right, #ff3333, #00ff00);
            transition: width 0.1s linear;
        }

        /* === í•˜ë‹¨ í™”ë©´ (í€´ì¦ˆ & í„°ì¹˜íŒ¨ë“œ) === */
        #bottom-screen {
            flex: 1;
            position: relative;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 5px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        /* í€´ì¦ˆ ì˜ì—­ */
        #quiz-area {
            width: 100%;
            height: 40%;
            background: #222;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 10px;
            box-sizing: border-box;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            margin-bottom: 10px;
            pointer-events: auto; 
            z-index: 20;
        }

        .q-type { color: #aaa; font-size: 12px; margin-bottom: 5px; font-weight: bold; }
        .q-text { color: white; font-size: 17px; font-weight: bold; line-height: 1.3; word-break: keep-all; }
        .q-answer { color: #00ff00; font-size: 18px; margin-top: 5px; font-weight: bold; display: none; }
        .q-timer { color: #00ffff; font-size: 24px; margin-top: 5px; font-family: monospace; display: none;}
        
        #mic-status { font-size: 11px; color: #666; position: absolute; bottom: 5px; width: 100%; left: 0; }
        .listening { color: #ff5555 !important; animation: pulse 1s infinite; }

        /* í„°ì¹˜íŒ¨ë“œ ì˜ì—­ */
        #touchpad-area {
            flex: 1;
            width: 100%;
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed #444;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #444;
            font-size: 12px;
            position: relative;
            touch-action: none;
        }
        
        #touch-feedback {
            position: absolute;
            width: 40px; height: 40px;
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
        }

        /* ì˜¤ë²„ë ˆì´ */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow-y: auto;
        }
        #game-over, #game-clear { display: none; z-index: 200; }

        .btn-start {
            padding: 15px 40px;
            font-size: 20px;
            background: #00ff00;
            color: black;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            width: 80%;
            max-width: 300px;
        }
        .btn-retry { background: #ff3333; color: white; }
        .btn-sub { background: #444; color: white; font-size: 16px; }

        /* ì„¤ì • UI */
        .settings-box {
            width: 90%;
            max-width: 500px;
            background: #222;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 75vh;
            overflow-y: auto;
        }
        
        .section-title { color: #00ffff; font-size: 16px; margin: 15px 0 5px 0; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .radio-group { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .checkbox-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        label { display: flex; align-items: center; gap: 5px; cursor: pointer; color: #ddd; font-size: 14px; }
        
        /* ë¬¸ì œ ì„ íƒ ëª¨ë‹¬ */
        #problem-selector {
            display: none;
            width: 100%;
        }
        .tab-container { display: flex; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #333; color: #888; }
        .tab.active { background: #555; color: white; font-weight: bold; }
        
        .problem-list {
            max-height: 200px;
            overflow-y: auto;
            background: #111;
            padding: 5px;
            border: 1px solid #444;
        }
        .problem-item {
            display: flex;
            align-items: flex-start;
            padding: 8px;
            border-bottom: 1px solid #333;
            font-size: 13px;
            text-align: left;
        }
        .problem-item input { margin-right: 10px; margin-top: 3px; flex-shrink: 0; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

<div id="ds-container">
    <!-- ìƒë‹¨ í™”ë©´ -->
    <div id="top-screen">
        <canvas id="game-canvas"></canvas>
        <div id="hp-bar-container"><div id="hp-bar"></div></div>
        
        <!-- ì‹¤íŒ¨ í™”ë©´ -->
        <div id="game-over" class="overlay">
            <h1 style="color:red">í›ˆë ¨ ì‹¤íŒ¨</h1>
            <p>ì˜ì—­ ì´íƒˆë¡œ ì¸í•œ ì¢…ë£Œ</p>
            <button class="btn-start btn-retry" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
        </div>
        
        <!-- ì™„ë£Œ í™”ë©´ -->
        <div id="game-clear" class="overlay">
            <h1 style="color:#00ff00">ëª¨ë“  ë¬¸ì œ ì™„ë£Œ</h1>
            <p>ì„ íƒí•œ ë¬¸ì œë¥¼ ëª¨ë‘ í’€ì—ˆìŠµë‹ˆë‹¤.</p>
            <div style="display:flex; flex-direction:column; width:100%; align-items:center;">
                <button class="btn-start" onclick="app.restartGame()">ë‹¤ì‹œ ì‹œì‘ (ë¬¸ì œ ì„ê¸°)</button>
                <button class="btn-start btn-sub" onclick="location.reload()">ì¢…ë£Œ (ì²« í™”ë©´)</button>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ í™”ë©´ -->
    <div id="bottom-screen">
        <div id="quiz-area">
            <div class="q-type" id="q-type">READY</div>
            <div class="q-text" id="q-text">í„°ì¹˜íŒ¨ë“œë¥¼ ì¡°ì‘í•˜ì—¬ ì‹œì‘</div>
            <div class="q-timer" id="q-timer">00.00</div>
            <div class="q-answer" id="q-answer">ì •ë‹µ</div>
            <div id="mic-status">ë§ˆì´í¬ ëŒ€ê¸° ì¤‘...</div>
        </div>

        <div id="touchpad-area">
            <div style="pointer-events: none;">TOUCH AREA (DRAG TO MOVE)</div>
            <div id="touch-feedback"></div>
        </div>
    </div>

    <!-- ì‹œì‘ ì„¤ì • -->
    <div id="start-screen" class="overlay">
        <h2 style="color:#00ff00; margin: 20px 0;">Focus Trainer Final</h2>
        
        <div class="settings-box">
            <!-- ë‚œì´ë„ -->
            <div class="section-title">ë‚œì´ë„ (ì†ë„)</div>
            <div class="radio-group">
                <label><input type="radio" name="diff" value="easy"> ì‰¬ì›€ (0.2ë°°)</label>
                <label><input type="radio" name="diff" value="normal" checked> ë³´í†µ (0.4ë°°)</label>
                <label><input type="radio" name="diff" value="hard"> ì–´ë ¤ì›€ (0.6ë°°)</label>
            </div>
            
            <!-- ìŒì„± ì„¤ì • -->
            <div class="section-title">ìŒì„± / TTS ì„¤ì •</div>
            <div class="checkbox-row">
                <label><input type="checkbox" id="use-voice" checked> ë‚´ ëª©ì†Œë¦¬ ì¸ì‹ (Chrome ê¶Œì¥)</label>
            </div>
            <div class="checkbox-row">
                <label><input type="checkbox" id="use-tts" checked> ë¬¸ì œ ì½ì–´ì£¼ê¸° (TTS)</label>
            </div>
            
            <!-- ë¬¸ì œ ì„¤ì • -->
            <div class="section-title">ë¬¸ì œ ì¶œì œ ë°©ì‹</div>
            <div class="radio-group">
                <label><input type="radio" name="q-mode" value="all" checked onchange="ui.toggleProblemSelector(false)"> ê¸°ì¶œ ì „ì²´ ëœë¤</label>
                <label><input type="radio" name="q-mode" value="select" onchange="ui.toggleProblemSelector(true)"> ë¬¸ì œ ì„ íƒ</label>
            </div>

            <!-- ë¬¸ì œ ì„ íƒê¸° -->
            <div id="problem-selector">
                <div class="tab-container">
                    <div id="tab-prev" class="tab active" onclick="ui.switchTab('prev')">ê¸°ì¡´ ê¸°ì¶œ</div>
                    <div id="tab-oral" class="tab" onclick="ui.switchTab('oral')">ì¶”ê°€ êµ¬ìˆ </div>
                </div>
                
                <div id="list-prev" class="problem-list"></div>
                <div id="list-oral" class="problem-list" style="display:none;"></div>
                
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn-sub" style="padding:5px 10px; width:auto;" onclick="ui.selectAll(true)">ì „ì²´ ì„ íƒ</button>
                    <button class="btn-sub" style="padding:5px 10px; width:auto;" onclick="ui.selectAll(false)">ì „ì²´ í•´ì œ</button>
                </div>
            </div>
        </div>

        <button class="btn-start" onclick="app.start()">í›ˆë ¨ ì‹œì‘</button>
    </div>
</div>

<script>
/* ------------------------------------------------------------------
   1. ë°ì´í„° (ë¬¸ì œ DB)
   - ë²ˆí˜¸ í¬í•¨ (ì„ íƒ UIìš©), ê²Œì„ ì¤‘ì—ëŠ” ì •ê·œì‹ìœ¼ë¡œ ì œê±°
   - êµ¬ìˆ : 6, 12 ì œì™¸
   - ê¸°ì¶œ: 7 ì œì™¸
------------------------------------------------------------------ */
const QUESTIONS_ORAL = [
    "1. ARL ì„¤ì¹˜ì°¨ëŸ‰ì˜ ì ‘ì§€ ë³µê·€ ë°©ë²•",
    "2. 7400í˜¸ëŒ€ ë””ì ¤ì „ê¸°ê¸°ê´€ì°¨ì— ì„¤ì¹˜ëœ ì „ë™ê¸°ì˜ ì¢…ë¥˜",
    "3. ì§€ì í™•ì¸ í™˜í˜¸ì‘ë‹µ í™˜í˜¸ìš©ì–´(ê¸°ì™¸ì •ì°¨ ê²½ê³ ë“± ê²½ê³  ì‹œ ë“±)",
    "4. ATP ìš´ì „ëª¨ë“œì˜ ì¢…ë¥˜",
    "5. ATP ìš´í–‰ ì‹œ íŠ¹ìˆ˜ìš´ì „ê¸°ëŠ¥ í™œì„±í™” ì‹œ ì´ë™ê±°ë¦¬ ì œí•œê³¼ í™œì„±í™” ì‹œê°„ ì œí•œ?",
    // 6 ì œì™¸
    "7. ì§€ë„í‘œì™€ ì§€ë„ê¶Œì— ëŒ€í•œ ì„¤ëª…",
    "8. ì§€ë ¹ì‹ì˜ ì •ì˜ì™€ í†µë³´ ë°›ê³  ê¸°ê´€ì‚¬ì˜ ì¡°ì¹˜(ìš´ì „ì·¨ê¸‰ê·œì • ì œ138ì¡°)",
    "9. ë¹„ì¥ì°©ëª¨ë“œë¡œ ìš´í–‰í•˜ì—¬ì•¼ í•˜ëŠ” ê²½ìš°",
    "10. ì €ìœ ì•• ê¸°ê´€ì •ì§€ì¥ì¹˜ê°€ ë™ì‘í•˜ëŠ” ê²½ìš°",
    "11. ë””ì ¤ì „ê¸°ê¸°ê´€ì°¨ ì €ì••ê³„í†µì˜ ì¢…ë¥˜",
    // 12 ì œì™¸
    "13. ê¸°ê´€ì „ë¶€ì— ìˆëŠ” ì¹˜ì°¨ì˜ ì¢…ë¥˜ì™€ ë¶€ì†ì¥ì¹˜ êµ¬ë™ì¹˜ì°¨ì™€ ë°˜ëŒ€ë°©í–¥ìœ¼ë¡œ íšŒì „í•˜ëŠ” ì¹˜ì°¨ì˜ ì¢…ë¥˜"
];

const QUESTIONS_PREV = [
    "1. ê³µê¸°ì œë™ì‹œí—˜ì„ ì‹œí–‰í•˜ëŠ” ê²½ìš°ëŠ” ì–¸ì œì¸ê°€?",
    "2. ì œë™ê°ë„ì‹œí—˜ì„ ìƒëµí•  ìˆ˜ ìˆëŠ” ê²½ìš°ëŠ” ì–¸ì œì¸ê°€?",
    "3. ì—´ì°¨ ìš´í–‰ ì¤‘ ì œë™ê¸° ì‚¬ìš©ë¶ˆëŠ¥ì°¨ ë°œìƒì‹œ ì¡°ì¹˜ëŠ”?",
    "4. 1íìƒ‰êµ¬ê°„ì— 2ê°œ ì—´ì°¨ë¥¼ ìš´ì „í•  ìˆ˜ ìˆëŠ” ê²½ìš°ëŠ” ì–¸ì œì¸ê°€",
    "5. ë³µì„  ìë™íìƒ‰êµ¬ê°„ì—ì„œ í†µì‹ ì‹ ì‹œí–‰ ê²½ìš° (5ê°€ì§€)",
    "5-1. í†µì‹ ì‹ ì‹œí–‰ì‹œì˜ ìš´ì „ë²•",
    "6. ìë™íìƒ‰ì‹ê³¼ ì§€ë„í†µì‹ ì‹ ë³‘ìš©ì‹œì˜ ìš´ì „ì·¨ê¸‰ë²•",
    // 7 ì œì™¸
    "8. êµ¬ì›ì—´ì°¨ ìš”êµ¬ì‹œì˜ ì·¨ê¸‰ë²•(êµ¬ì›ì„ ìš”êµ¬í•œ ê³ ì¥ì—´ì°¨)",
    "9. êµ¬ì›ì—´ì°¨ ìš´ì „ë²•(êµ¬ì›í•˜ëŸ¬ ê°€ëŠ” ì—´ì°¨)",
    "10. ì „ë ¹ë²• ì‹œí–‰ ì‹œ ìš´ì „ì·¨ê¸‰ë²•ì€?",
    "11. ì›ë°©ì‹ í˜¸ ì£¼ì˜ì‹ í˜¸ í˜„ì‹œ ì‹œ ì£¼ì˜ì‹ í˜¸ ì†ë„ ì´ìƒìœ¼ë¡œ ìš´ì „ê°€ëŠ¥í•œ ê²½ìš°ëŠ” ì–¸ì œì¸ê°€",
    "12. ê¸°ì  ê³ ì¥ì‹œì˜ ìš´ì „ë²•",
    "13. ì •ê±°ì¥ì—ì„œ ì—´ì°¨ë¥¼ ë™ì‹œì— ì§„ì… ë° ì§„ì¶œ ê°€ëŠ¥í•œ ê²½ìš°ëŠ” ì–¸ì œì¸ê°€",
    "14. ì¹¨ìˆ˜ëœ ì„ ë¡œë¥¼ ìš´ì „ ì‹œ ì—´ì°¨ ìš´ì „ë²•ì€?",
    "15. ì´ê´„ì œì–´ì‹œ í”¼ì œì–´ì°¨ì˜ ê¸°ê¸°ì·¨ê¸‰ë²•ê³¼ ìš´ì „ë³´ì•ˆì¥ì¹˜ ì·¨ê¸‰ë²•",
    "16. ì´ê´„ì œì–´ì‹œ í”¼ì œì–´ì°¨ë¥¼ ì œì–´ì°¨ë¡œ ë§Œë“œëŠ” ë°©ë²•",
    "17-18. 26-Fì œì–´ë³€ì˜ ê¸°ëŠ¥ê³¼ ê³ ì¥ì‹œì˜ í˜„ìƒ",
    "19-20. J-1ì¤‘ê³„ë³€ì˜ ê¸°ëŠ¥ê³¼ ê³ ì¥ì‹œì˜ í˜„ìƒ",
    "21. ìë³€ ì·¨ê¸‰ë²•(ìë³€ìœ¼ë¡œ ì œë™ ì²´ê²°ì‹œ ì²´ê²°ê³¼ì •)",
    "22. ë‹¨ë³€ ì·¨ê¸‰ë²•(ë‹¨ë³€ìœ¼ë¡œ ì œë™ ì²´ê²°ì‹œ ì²´ê²°ê³¼ì •)",
    "23. A-1ì¶©ê¸°ì°¨ë‹¨ì•ˆë‚´ë³€ ë™ì‘ì›ì¸ê³¼ í˜„ìƒ, ì¡°ì¹˜ë°©ë²•",
    "24. ì£¼ê³µê¸°ì••ë ¥ì´ 9í‚¤ë¡œê¹Œì§€ ìƒìŠ¹ë¶ˆëŠ¥ì‹œ ì›ì¸ 5ê°€ì§€",
    "25. ê³µê¸°ì••ì¶•ê¸° ê³„ì† ë¬´ë¶€í•˜ ìš´ì „ì‹œì˜ ì¡°ì¹˜ ìˆœì„œ",
    "26. ê¸°ê´€ì œì–´íŒ¨ë„ì˜ ë¬´ì¶©ì „/ë¬´ì „ì›ë“±(NVRë“±) ì ë“± ì‹œ í™•ì¸í•´ì•¼ ë  ê²ƒ 5ê°€ì§€",
    "27. ì—¬ìì œí•œ ê²½ë³´ì˜ í˜„ìƒê³¼ ì¡°ì¹˜ë°©ë²•",
    "28. ê¸°ê´€íšŒì „ì†ë„ëŠ” ì •ìƒì´ë‚˜ ì£¼ë°œì „ê¸° ì¶œë ¥ì´ ë‚˜ì§€ ì•ŠëŠ” ê²½ìš°",
    "29. ì¡°ì†ê¸°ì¤‘ì§€ë“± ì ë“± ì‹œì˜ í˜„ìƒ 3ê°€ì§€ì— ëŒ€í•´ ë§í•´ë³´ì‹­ì‹œì˜¤",
    "30. ê¸°ê´€ì œì–´íŒ¨ë„ì˜ ì¡°ì†ê¸°ì¤‘ì§€ë“± ì ë“± ì›ì¸ 3ê°€ì§€ì— ëŒ€í•´ ë§í•´ë³´ì‹­ì‹œì˜¤",
    "31. ê¸°ê´€ì˜¨ë„ìŠ¤ìœ„ì¹˜ ê¸°ëŠ¥ì‹œí—˜ ë°©ë²•ê³¼ ë™ì‘ì˜¨ë„",
    "32. TR16 ì „ì´ì œì–´ëª¨ë“ˆ ê¸°ëŠ¥ê²€ì‚¬ë²•ê³¼ ë°œì „ì œë™ì˜ ì›ë¦¬",
    "33. ê²½ë³´ê¸°ëª¨ë“ˆ AN29 ì ë“± ì‹œê¸° 6ê°€ì§€, ì ê²€ë°©ë²•",
    "34. ATS, ATC, ATP, ì—´ì°¨ë°©í˜¸ì¥ì¹˜ëŠ” ë¬´ì—‡ì¸ê°€",
    "35. ì—´ì°¨ë°©í˜¸ì¥ì¹˜ ë™ì‘ì‹œ ìš´ì „ì·¨ê¸‰ë²•",
    "35-1. ì—´ì°¨ë°©í˜¸ì¥ì¹˜ ì°¨ë‹¨ ë°©ë²•",
    "36. ì‹ í˜¸ë³´ì•ˆì¥ì¹˜ ì¥ì• ë°œìƒì‹œ(ê³ ì¥ì‹œ) ê¸°ê´€ì°¨ ì¡°ì¹˜ 3ê°œ",
    "37. ì—´ì°¨ì œì–´ì¥ì¹˜ ì°¨ë‹¨ìš´ì „ ìŠ¹ì¸ë²ˆí˜¸ë¥¼ ë¶€ì—¬ë°›ì•„ ì—´ì°¨ë¥¼ ìš´í–‰ì‹œí‚¬ ìˆ˜ ìˆëŠ” ê²½ìš°",
    "38. ATP ë ˆë²¨STMì˜ ëª¨ë“œì—ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆëŠ”ê°€",
    "39. ATP ë ˆë²¨ STMì˜ ì…í™˜ëª¨ë“œëŠ” ì–¸ì œ ì‚¬ìš©í•˜ëŠ”ê°€",
    "40. ATP ë ˆë²¨ STMì˜ ê³µì‚¬ëª¨ë“œëŠ” ì–¸ì œ ì‚¬ìš©í•˜ëŠ”ê°€",
    "41. ATP ë ˆë²¨ STMì˜ íŠ¹ìˆ˜ëª¨ë“œëŠ” ì–¸ì œ ì‚¬ìš©í•˜ëŠ”ê°€",
    "42. ATP ë¹„ì¥ì°©ëª¨ë“œ(ë ˆë²¨ 0)ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°"
];

/* ------------------------------------------------------------------
   2. í„°ì¹˜íŒ¨ë“œ ì»¨íŠ¸ë¡¤ëŸ¬ (TouchPad)
------------------------------------------------------------------ */
class TouchPad {
    constructor(areaId, feedbackId, onMove) {
        this.area = document.getElementById(areaId);
        this.feedback = document.getElementById(feedbackId);
        this.onMove = onMove; 
        
        this.active = false;
        this.touchId = null;
        this.origin = { x: 0, y: 0 };
        this.maxDist = 50; 

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        this.area.addEventListener('touchstart', e => this.start(e), {passive: false});
        this.area.addEventListener('touchmove', e => this.move(e), {passive: false});
        this.area.addEventListener('touchend', e => this.end(e));
        this.area.addEventListener('mousedown', e => this.start(e));
        document.addEventListener('mousemove', e => this.move(e));
        document.addEventListener('mouseup', e => this.end(e));
    }

    start(e) {
        e.preventDefault();
        this.active = true;
        
        let clientX, clientY;
        if (e.touches) {
            this.touchId = e.changedTouches[0].identifier;
            clientX = e.changedTouches[0].clientX;
            clientY = e.changedTouches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        this.origin = { x: clientX, y: clientY };
        
        this.feedback.style.display = 'block';
        this.feedback.style.left = clientX + 'px';
        this.feedback.style.top = clientY + 'px';
        this.feedback.style.transform = 'translate(-50%, -50%)';
        
        this.onMove(0, 0);
    }

    move(e) {
        if (!this.active) return;
        e.preventDefault();
        
        let clientX, clientY;
        if (e.touches) {
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === this.touchId) {
                    clientX = e.changedTouches[i].clientX;
                    clientY = e.changedTouches[i].clientY;
                    break;
                }
            }
            if (clientX === undefined) return;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        const dx = clientX - this.origin.x;
        const dy = clientY - this.origin.y;
        
        let nx = Math.max(-1, Math.min(1, dx / this.maxDist));
        let ny = Math.max(-1, Math.min(1, dy / this.maxDist));
        
        const visualDist = Math.min(Math.sqrt(dx*dx + dy*dy), this.maxDist);
        const angle = Math.atan2(dy, dx);
        const vx = Math.cos(angle) * visualDist;
        const vy = Math.sin(angle) * visualDist;
        
        this.feedback.style.transform = `translate(calc(-50% + ${vx}px), calc(-50% + ${vy}px))`;
        this.onMove(nx, ny);
    }

    end(e) {
        if (!this.active) return;
        this.active = false;
        this.feedback.style.display = 'none';
        this.onMove(0, 0);
    }
}

/* ------------------------------------------------------------------
   3. ì¶”ì  ê²Œì„ (Tracker)
------------------------------------------------------------------ */
class TrackerGame {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        
        this.player = { x: 0, y: 0, radius: 8, vx: 0, vy: 0, targetVx: 0, targetVy: 0 };
        this.zone = { x: 0, y: 0, width: 100, height: 100, radius: 0, targetX: 0, targetY: 0 };
        
        this.difficulty = 'normal'; 
        this.playerSpeed = 6; 
        this.zoneMaxSpeed = 0; 
        
        this.health = 100;
        this.active = false;
        this.moveTimer = 0; 
        
        this.resize();
        window.addEventListener('resize', () => this.resize());
    }

    resize() {
        this.canvas.width = this.canvas.parentElement.clientWidth;
        this.canvas.height = this.canvas.parentElement.clientHeight;
        if (!this.active) {
            this.player.x = this.canvas.width / 2;
            this.player.y = this.canvas.height / 2;
            this.zone.x = this.canvas.width / 2;
            this.zone.y = this.canvas.height / 2;
        }
    }

    start(diff) {
        this.difficulty = diff;
        this.active = true;
        this.health = 100;
        
        this.player.x = this.canvas.width / 2;
        this.player.y = this.canvas.height / 2;
        this.player.vx = 0; this.player.vy = 0;
        this.player.targetVx = 0; this.player.targetVy = 0;

        this.zone.x = this.canvas.width / 2;
        this.zone.y = this.canvas.height / 2;
        this.zone.targetX = this.zone.x;
        this.zone.targetY = this.zone.y;

        if (diff === 'easy') {
            this.zoneMaxSpeed = this.playerSpeed * 0.2;
            this.zone.width = 140; this.zone.height = 140;
            this.zone.radius = 0;
        } else if (diff === 'normal') {
            this.zoneMaxSpeed = this.playerSpeed * 0.4;
            this.zone.width = 120; this.zone.height = 120;
            this.zone.radius = 10; 
        } else {
            this.zoneMaxSpeed = this.playerSpeed * 0.6;
            this.zone.width = 100; this.zone.height = 100;
            this.zone.radius = 10;
        }
    }

    setInput(x, y) {
        this.player.targetVx = x * this.playerSpeed;
        this.player.targetVy = y * this.playerSpeed;
    }

    update() {
        if (!this.active) return;

        this.player.vx += (this.player.targetVx - this.player.vx) * 0.15;
        this.player.vy += (this.player.targetVy - this.player.vy) * 0.15;
        this.player.x += this.player.vx;
        this.player.y += this.player.vy;
        this.player.x = Math.max(0, Math.min(this.canvas.width, this.player.x));
        this.player.y = Math.max(0, Math.min(this.canvas.height, this.player.y));

        this.updateZoneAI();
        this.checkCollision();
    }

    updateZoneAI() {
        const pad = 80;
        if (this.difficulty === 'easy') {
            if (this.moveTimer <= 0) {
                this.zone.targetX = pad + Math.random() * (this.canvas.width - pad*2);
                this.zone.targetY = pad + Math.random() * (this.canvas.height - pad*2);
                this.moveTimer = 200; 
            }
            this.moveTimer--;
            this.zone.x += (this.zone.targetX - this.zone.x) * 0.005;
            this.zone.y += (this.zone.targetY - this.zone.y) * 0.005;
        } 
        else if (this.difficulty === 'normal') {
            if (this.moveTimer <= 0) {
                this.zone.targetX = pad + Math.random() * (this.canvas.width - pad*2);
                this.zone.targetY = pad + Math.random() * (this.canvas.height - pad*2);
                this.moveTimer = 120; 
            }
            this.moveTimer--;
            this.zone.x += (this.zone.targetX - this.zone.x) * 0.01;
            this.zone.y += (this.zone.targetY - this.zone.y) * 0.01;
        }
        else {
            const dx = this.zone.targetX - this.zone.x;
            const dy = this.zone.targetY - this.zone.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 10 || this.moveTimer <= 0) {
                this.zone.targetX = pad + Math.random() * (this.canvas.width - pad*2);
                this.zone.targetY = pad + Math.random() * (this.canvas.height - pad*2);
                this.moveTimer = 60 + Math.random() * 60;
            }
            this.moveTimer--;
            const angle = Math.atan2(dy, dx);
            this.zone.x += Math.cos(angle) * this.zoneMaxSpeed;
            this.zone.y += Math.sin(angle) * this.zoneMaxSpeed;
            
            const time = Date.now() / 1000;
            const morphFactor = (Math.sin(time) + 1) / 2;
            this.zone.radius = 10 + (morphFactor * 20);
        }
        this.zone.x = Math.max(pad, Math.min(this.canvas.width - pad, this.zone.x));
        this.zone.y = Math.max(pad, Math.min(this.canvas.height - pad, this.zone.y));
    }

    checkCollision() {
        const halfW = this.zone.width / 2;
        const halfH = this.zone.height / 2;
        const dx = Math.abs(this.player.x - this.zone.x);
        const dy = Math.abs(this.player.y - this.zone.y);
        let inside = false;

        if (this.difficulty === 'hard' && this.zone.radius > 20) {
            const dist = Math.sqrt((this.player.x - this.zone.x)**2 + (this.player.y - this.zone.y)**2);
            if (dist < (this.zone.width / 2)) inside = true;
        } else {
            if (dx < halfW && dy < halfH) inside = true;
        }

        const hpBar = document.getElementById('hp-bar');
        if (inside) {
            this.ctx.strokeStyle = "#00ff00"; 
            this.health = Math.min(100, this.health + 0.1);
        } else {
            this.ctx.strokeStyle = "#ff0000"; 
            this.health -= 0.05; 
            if (this.health <= 0) {
                this.health = 0;
                app.gameOver();
            }
        }
        hpBar.style.width = this.health + "%";
    }

    render() {
        this.ctx.fillStyle = "#000";
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        this.ctx.strokeStyle = "#222";
        this.ctx.lineWidth = 1;
        const gridSize = 50;
        this.ctx.beginPath();
        for(let x=0; x<this.canvas.width; x+=gridSize) {
            this.ctx.moveTo(x, 0); this.ctx.lineTo(x, this.canvas.height);
        }
        for(let y=0; y<this.canvas.height; y+=gridSize) {
            this.ctx.moveTo(0, y); this.ctx.lineTo(this.canvas.width, y);
        }
        this.ctx.stroke();

        this.ctx.lineWidth = 4;
        this.drawRoundRect(this.zone.x - this.zone.width/2, this.zone.y - this.zone.height/2, 
                           this.zone.width, this.zone.height, this.zone.radius);
        this.ctx.stroke();
        
        this.ctx.fillStyle = this.ctx.strokeStyle === "#00ff00" ? "rgba(0, 255, 0, 0.1)" : "rgba(255, 0, 0, 0.1)";
        this.ctx.fill();

        this.ctx.fillStyle = "#00ffff";
        this.ctx.shadowBlur = 10;
        this.ctx.shadowColor = "#00ffff";
        this.ctx.beginPath();
        this.ctx.arc(this.player.x, this.player.y, this.player.radius, 0, Math.PI*2);
        this.ctx.fill();
        this.ctx.shadowBlur = 0;
    }

    drawRoundRect(x, y, w, h, r) {
        this.ctx.beginPath();
        this.ctx.moveTo(x + r, y);
        this.ctx.arcTo(x + w, y, x + w, y + h, r);
        this.ctx.arcTo(x + w, y + h, x, y + h, r);
        this.ctx.arcTo(x, y + h, x, y, r);
        this.ctx.arcTo(x, y, x + w, y, r);
        this.ctx.closePath();
    }
}

/* ------------------------------------------------------------------
   4. í€´ì¦ˆ ë§¤ë‹ˆì €
------------------------------------------------------------------ */
class QuizManager {
    constructor() {
        this.currentSet = [];
        this.remaining = [];
        this.active = false;
        this.state = 'idle'; 
        this.timerStart = 0;
        this.timerRef = null;
        this.nextTimer = null;
        this.useVoice = false;
        this.useTTS = false; // TTS ì˜µì…˜ ì¶”ê°€
        this.recognition = null;
        this.initVoice();
    }

    initVoice() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SR) {
            this.recognition = new SR();
            this.recognition.lang = 'ko-KR';
            this.recognition.continuous = true;
            this.recognition.interimResults = false;
            this.recognition.onresult = (e) => {
                const txt = e.results[e.results.length-1][0].transcript.replace(/\s/g, '');
                this.processVoice(txt);
            };
            this.recognition.onend = () => {
                if (this.active && this.useVoice) try{this.recognition.start()}catch(e){}
            };
        }
    }

    processVoice(txt) {
        if (this.state === 'question') {
            if (txt.startsWith('ì˜ˆ') || txt.startsWith('ë„¤')) {
                this.startAnswering();
            }
        } else if (this.state === 'answering') {
            if (txt.includes('ì´ìƒ') || txt.includes('ë')) {
                this.finishAnswering();
            }
        }
    }

    setQuestions(list) {
        this.currentSet = [...list];
    }

    start(useVoice, useTTS) {
        this.active = true;
        this.useVoice = useVoice;
        this.useTTS = useTTS;
        this.remaining = [...this.currentSet].sort(() => Math.random() - 0.5);
        if (useVoice && this.recognition) try{this.recognition.start()}catch(e){}
        
        this.scheduleNext();
    }

    stop() {
        this.active = false;
        if (this.recognition) try{this.recognition.stop()}catch(e){}
        clearTimeout(this.nextTimer);
        cancelAnimationFrame(this.timerRef);
        window.speechSynthesis.cancel(); // TTS ì¤‘ë‹¨
    }

    scheduleNext() {
        if (this.remaining.length === 0) {
            app.gameClear();
            return;
        }

        const delay = 3000 + Math.random() * 3000;
        this.state = 'idle';
        
        document.getElementById('q-type').innerText = "STANDBY";
        document.getElementById('q-text').innerText = `ëŒ€ê¸° ì¤‘... (ë‚¨ì€ ë¬¸ì œ: ${this.remaining.length})`;
        document.getElementById('q-answer').style.display = 'none';
        document.getElementById('q-timer').style.display = 'none';
        document.getElementById('mic-status').innerText = "ì¹¨ë¬µ ìœ ì§€";
        document.getElementById('mic-status').className = "";

        this.nextTimer = setTimeout(() => this.showQuestion(), delay);
    }

    showQuestion() {
        if (!this.active) return;
        const rawQ = this.remaining.pop();
        this.currentQ = rawQ;
        
        // í™”ë©´ì— ë³´ì—¬ì¤„ í…ìŠ¤íŠ¸ (ë²ˆí˜¸ ì œê±°)
        // ì •ê·œì‹: ì‹œì‘ ë¶€ë¶„ì˜ "ìˆ«ì." ë˜ëŠ” "ìˆ«ì-ìˆ«ì." íŒ¨í„´ ì œê±°
        const displayText = rawQ.replace(/^[0-9]+(-[0-9]+)?\.\s*/, "");

        this.state = 'question';
        document.getElementById('q-type').innerText = "QUESTION";
        document.getElementById('q-text').innerText = displayText;
        
        // TTS ì½ê¸°
        if (this.useTTS) {
            this.speak(displayText);
        }

        const micEl = document.getElementById('mic-status');
        if (this.useVoice) {
            micEl.innerText = "ğŸ¤ 'ì˜ˆ'ë¼ê³  ë‹µí•˜ë©´ ì‹œì‘";
            micEl.className = "listening";
        } else {
            micEl.innerText = "í„°ì¹˜í•˜ì—¬ ë‹µë³€ ì‹œì‘";
            micEl.className = "";
        }
    }
    
    speak(text) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel(); // ì´ì „ ìŒì„± ì¤‘ë‹¨
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 1.0; // ì†ë„ ì¡°ì ˆ ê°€ëŠ¥
        window.speechSynthesis.speak(utterance);
    }

    startAnswering() {
        window.speechSynthesis.cancel(); // ë‹µë³€ ì‹œì‘í•˜ë©´ TTS ì¤‘ë‹¨
        this.state = 'answering';
        this.timerStart = performance.now();
        document.getElementById('q-type').innerText = "RECORDING...";
        document.getElementById('q-timer').style.display = 'block';
        
        const micEl = document.getElementById('mic-status');
        if (this.useVoice) {
            micEl.innerText = "ğŸ—£ï¸ ë‹µë³€ í›„ 'ì´ìƒì…ë‹ˆë‹¤' ë°œì–¸";
        } else {
            micEl.innerText = "ë‹µë³€ í›„ í„°ì¹˜í•˜ì—¬ ì¢…ë£Œ";
        }
        this.updateTimer();
    }

    updateTimer() {
        if (this.state !== 'answering') return;
        const now = performance.now();
        const t = (now - this.timerStart) / 1000;
        document.getElementById('q-timer').innerText = t.toFixed(2);
        this.timerRef = requestAnimationFrame(() => this.updateTimer());
    }

    finishAnswering() {
        this.state = 'result';
        cancelAnimationFrame(this.timerRef);
        document.getElementById('q-type').innerText = "DONE";
        document.getElementById('mic-status').innerText = "3ì´ˆ í›„ ìë™ ë‹«í˜";
        document.getElementById('mic-status').className = "";
        
        setTimeout(() => {
            if(this.active) this.scheduleNext();
        }, 3000);
    }

    handleTouch() {
        if (this.state === 'question') this.startAnswering();
        else if (this.state === 'answering') this.finishAnswering();
    }
}

/* ------------------------------------------------------------------
   5. UI ë° ì•± ì»¨íŠ¸ë¡¤ëŸ¬
------------------------------------------------------------------ */
const ui = {
    toggleProblemSelector: function(show) {
        document.getElementById('problem-selector').style.display = show ? 'block' : 'none';
    },
    switchTab: function(tab) {
        const tabPrev = document.getElementById('tab-prev');
        const tabOral = document.getElementById('tab-oral');
        const listPrev = document.getElementById('list-prev');
        const listOral = document.getElementById('list-oral');

        if (tab === 'prev') {
            tabPrev.classList.add('active');
            tabOral.classList.remove('active');
            listPrev.style.display = 'block';
            listOral.style.display = 'none';
        } else {
            tabPrev.classList.remove('active');
            tabOral.classList.add('active');
            listPrev.style.display = 'none';
            listOral.style.display = 'block';
        }
    },
    renderList: function(id, list) {
        const container = document.getElementById(id);
        // ê¸°ë³¸ ì²´í¬ í•´ì œ ìƒíƒœë¡œ ë Œë”ë§
        container.innerHTML = list.map(q => `
            <label class="problem-item">
                <input type="checkbox" value="${q}">
                ${q}
            </label>
        `).join('');
    },
    selectAll: function(select) {
        const activeListId = document.getElementById('list-prev').style.display !== 'none' ? 'list-prev' : 'list-oral';
        const inputs = document.getElementById(activeListId).querySelectorAll('input');
        inputs.forEach(input => input.checked = select);
    },
    getSelectedQuestions: function() {
        const mode = document.querySelector('input[name="q-mode"]:checked').value;
        if (mode === 'all') {
            return [...QUESTIONS_PREV, ...QUESTIONS_ORAL];
        } else {
            const inputs = document.querySelectorAll('.problem-item input:checked');
            return Array.from(inputs).map(input => input.value);
        }
    }
};

const tracker = new TrackerGame('game-canvas');
const quiz = new QuizManager();

const app = {
    init: function() {
        ui.renderList('list-prev', QUESTIONS_PREV);
        ui.renderList('list-oral', QUESTIONS_ORAL);
    },
    start: function() {
        const diff = document.querySelector('input[name="diff"]:checked').value;
        const useVoice = document.getElementById('use-voice').checked;
        const useTTS = document.getElementById('use-tts').checked;
        
        const selectedQ = ui.getSelectedQuestions();
        if (selectedQ.length === 0) {
            alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        quiz.setQuestions(selectedQ);
        tracker.start(diff);
        quiz.start(useVoice, useTTS);

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-over').style.display = 'none';
        document.getElementById('game-clear').style.display = 'none';
        
        this.loop();
    },
    loop: function() {
        if (!tracker.active) return;
        tracker.update();
        tracker.render();
        requestAnimationFrame(() => this.loop());
    },
    gameOver: function() {
        tracker.active = false;
        quiz.stop();
        document.getElementById('game-over').style.display = 'flex';
    },
    gameClear: function() {
        tracker.active = false;
        quiz.stop();
        document.getElementById('game-clear').style.display = 'flex';
    },
    restartGame: function() {
        const useVoice = document.getElementById('use-voice').checked;
        const useTTS = document.getElementById('use-tts').checked;
        document.getElementById('game-clear').style.display = 'none';
        
        tracker.active = true;
        tracker.health = 100; 
        quiz.start(useVoice, useTTS);
        this.loop();
    }
};

// ì´ˆê¸°í™” ì‹¤í–‰
app.init();

new TouchPad('touchpad-area', 'touch-feedback', (x, y) => {
    tracker.setInput(x, y);
});

document.getElementById('quiz-area').addEventListener('mousedown', () => quiz.handleTouch());
document.getElementById('quiz-area').addEventListener('touchstart', (e) => {
    e.preventDefault();
    quiz.handleTouch();
});

</script>
</body>
</html>
